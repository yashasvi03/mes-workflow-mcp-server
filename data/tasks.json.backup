[
  {
    "id": "DISP-M-001",
    "parent_id": null,
    "name": "Pre-Dispensing & Room Readiness",
    "type": "Macro",
    "stage": "Pre-Dispensing",
    "actor": "QA/Production",
    "integration": "MES",
    "inputs": "Room Status",
    "outputs": "",
    "predecessors": [],
    "edge_type": "",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Area Cleaning Logbook; Room Readiness Log",
    "controls": "QA approval gates apply"
  },
  {
    "id": "DISP-M-002",
    "parent_id": null,
    "name": "Material Identification, Allocation & Staging",
    "type": "Macro",
    "stage": "Material Allocation",
    "actor": "Warehouse/Production/MES",
    "integration": "SAP/WMS/MES",
    "inputs": "Production Order; BOM",
    "outputs": "Allocated Lots; Staged Materials",
    "predecessors": ["DISP-M-001"],
    "edge_type": "control",
    "guard_condition": "QA start approved",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Staging Log; Lot Allocation Log",
    "controls": "Interlocks for wrong material/lot"
  },
  {
    "id": "DISP-M-003",
    "parent_id": null,
    "name": "Container-by-Container Dispensing (Weighing Path)",
    "type": "Macro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "Balance/LIMS/MES",
    "inputs": "Staged Containers; Assay/LOD",
    "outputs": "Dispensed Containers; Remnants",
    "predecessors": ["DISP-M-002"],
    "edge_type": "control",
    "guard_condition": "Q-SEC-01='Weighing only' OR Q-SEC-01='Both (material-dependent)'",
    "decision_id": "Q-SEC-01",
    "decision_outcome": "Weighing only,Both (material-dependent)",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Balance Usage Log; WB Slip",
    "controls": "Tolerance checks & approvals"
  },
  {
    "id": "DISP-M-004",
    "parent_id": null,
    "name": "Sealed Container Dispensing (No-Weigh Path)",
    "type": "Macro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "MES",
    "inputs": "Sealed Containers with Declared Net Mass",
    "outputs": "Dispensed Containers",
    "predecessors": ["DISP-M-002"],
    "edge_type": "control",
    "guard_condition": "Q-SEC-01='Sealed only' OR Q-SEC-01='Both (material-dependent)'",
    "decision_id": "Q-SEC-01",
    "decision_outcome": "Sealed only,Both (material-dependent)",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Sealed Container Log; Warehouse Label Reference",
    "controls": "No weighing; declared weight only"
  },
  {
    "id": "DISP-M-005",
    "parent_id": null,
    "name": "Labeling, Reconciliation & Documentation",
    "type": "Macro",
    "stage": "Labeling & Documentation",
    "actor": "Operator/QA/MES",
    "integration": "MES/Printer",
    "inputs": "Dispensed Container Data",
    "outputs": "Container Labels; Kit/Aggregate Labels",
    "predecessors": ["DISP-M-003", "DISP-M-004"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Label governance applied"
  },
  {
    "id": "DISP-M-006",
    "parent_id": null,
    "name": "Post-Dispensing Transfer, TOR & ERP Posting",
    "type": "Macro",
    "stage": "Post-Dispensing",
    "actor": "Warehouse/QA/MES",
    "integration": "SAP/WMS/MES",
    "inputs": "Dispensed units",
    "outputs": "Transferred Units; ERP GI",
    "predecessors": ["DISP-M-005"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Chain-of-Custody Log; TOR Log",
    "controls": "Reconciliation and posting rules"
  },
  {
    "id": "DISP-001",
    "parent_id": "DISP-M-001",
    "name": "Training & role gate",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "MES",
    "integration": "MES↔LMS/HR",
    "inputs": "User ID",
    "outputs": "Access decision",
    "predecessors": [],
    "edge_type": "",
    "guard_condition": "",
    "decision_id": "Q-HR-01",
    "decision_outcome": "Block if expired",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Training Compliance Log",
    "controls": "Block step if training out-of-date"
  },
  {
    "id": "DISP-002",
    "parent_id": "DISP-M-001",
    "name": "Line clearance request & checklist",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "Production",
    "integration": "MES",
    "inputs": "SOP checklist",
    "outputs": "Line clearance request",
    "predecessors": ["DISP-001"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Area Cleaning Logbook",
    "controls": "E-sign request"
  },
  {
    "id": "DISP-003",
    "parent_id": "DISP-M-001",
    "name": "Verify previous batch clearance and remove residuals",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "Room",
    "outputs": "Cleared area",
    "predecessors": ["DISP-002"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Room Readiness Log",
    "controls": "Checklist required"
  },
  {
    "id": "DISP-004",
    "parent_id": "DISP-M-001",
    "name": "Check room cleaning hold-time validity",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Cleaning timestamp",
    "outputs": "Validity status",
    "predecessors": ["DISP-003"],
    "edge_type": "data",
    "guard_condition": "now - cleaning_time <= hold_time",
    "decision_id": "C-CLN-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Area Cleaning Logbook",
    "controls": "Stop if expired"
  },
  {
    "id": "DISP-005",
    "parent_id": "DISP-M-001",
    "name": "If cleaning hold-time expired, perform cleaning & record",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "SOP-DISP-CLN",
    "outputs": "New cleaning record",
    "predecessors": ["DISP-004"],
    "edge_type": "exception",
    "guard_condition": "now - cleaning_time > hold_time",
    "decision_id": "C-CLN-01",
    "decision_outcome": "No → Trigger cleaning",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Area Cleaning Logbook",
    "controls": "Return to clearance flow"
  },
  {
    "id": "DISP-006",
    "parent_id": "DISP-M-001",
    "name": "Capture RT/RH/DP (auto/manual) & evaluate limits",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "Operator/MES",
    "integration": "Historian/MES",
    "inputs": "Sensors; manual entries",
    "outputs": "Env readings",
    "predecessors": ["DISP-003"],
    "edge_type": "data",
    "guard_condition": "env.readings_captured AND (env.within_limits OR policy_allows_proceed_with_deviation)",
    "decision_id": "Q-ENV-01",
    "decision_outcome": "Automated (historian/HVAC)",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Environment Log",
    "controls": "Auto alert & deviation link if out-of-range"
  },
  {
    "id": "DISP-006D",
    "parent_id": "DISP-M-001",
    "name": "Proceed under deviation with QA approval (environment excursion)",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "QA/MES",
    "integration": "MES↔QMS",
    "inputs": "Env readings; risk assessment",
    "outputs": "Approved deviation record",
    "predecessors": ["DISP-006"],
    "edge_type": "exception",
    "guard_condition": "env.within_limits=false AND policy_allows_proceed_with_deviation=true",
    "decision_id": "Q-ENV-03",
    "decision_outcome": "Proceed with deviation",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Deviation Log",
    "controls": "QA approver e-sign; time-bound"
  },
  {
    "id": "DISP-007",
    "parent_id": "DISP-M-001",
    "name": "PPE & containment per material risk",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "Operator/QA",
    "integration": "MES",
    "inputs": "Material risk category",
    "outputs": "PPE check",
    "predecessors": ["DISP-003"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-HSE-01",
    "decision_outcome": "HPAPI",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "HSE Checklist",
    "controls": "Supervisor verify"
  },
  {
    "id": "DISP-008",
    "parent_id": "DISP-M-001",
    "name": "Balance calibration/verification validity check",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "MES",
    "integration": "MES/CMMS/ERP",
    "inputs": "Balance ID; calibration status",
    "outputs": "Validity decision",
    "predecessors": ["DISP-003"],
    "edge_type": "data",
    "guard_condition": "balance.valid=true",
    "decision_id": "C-CAL-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Calibration Logbook",
    "controls": "Interlock if invalid"
  },
  {
    "id": "DISP-009",
    "parent_id": "DISP-M-001",
    "name": "QA room readiness inspection & e-sign",
    "type": "Micro",
    "stage": "Pre-Dispensing",
    "actor": "QA",
    "integration": "MES",
    "inputs": "Completed checklists",
    "outputs": "QA approval",
    "predecessors": ["DISP-004", "DISP-006", "DISP-008"],
    "edge_type": "control",
    "guard_condition": "env.ok & equipment.ok",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Room Readiness Log",
    "controls": "Gate to start dispensing"
  },
  {
    "id": "DISP-010",
    "parent_id": "DISP-M-002",
    "name": "Retrieve production order & BOM",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES",
    "integration": "SAP↔MES",
    "inputs": "Order ID",
    "outputs": "BOM items",
    "predecessors": ["DISP-M-001"],
    "edge_type": "data",
    "guard_condition": "order.status=released",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Order Log",
    "controls": "Version-controlled BOM"
  },
  {
    "id": "DISP-011",
    "parent_id": "DISP-M-002",
    "name": "Sync material master (expiry, storage, status, TOR rules)",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES",
    "integration": "SAP↔MES",
    "inputs": "Material IDs",
    "outputs": "Attributes cache",
    "predecessors": ["DISP-010"],
    "edge_type": "data",
    "guard_condition": "master.synced=true",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Master Data Sync Log",
    "controls": "Timestamped master data"
  },
  {
    "id": "DISP-012",
    "parent_id": "DISP-M-002",
    "name": "Fetch available inventory lots",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES/WMS",
    "integration": "SAP/WMS↔MES",
    "inputs": "Material IDs",
    "outputs": "Lot list",
    "predecessors": ["DISP-011"],
    "edge_type": "data",
    "guard_condition": "stock.view available",
    "decision_id": "Q-WMS-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Inventory Snapshot",
    "controls": "Real-time stock"
  },
  {
    "id": "DISP-013",
    "parent_id": "DISP-M-002",
    "name": "Filter lots by allowed status and re-test validity",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES",
    "integration": "MES/LIMS/ERP",
    "inputs": "Lot attributes",
    "outputs": "Eligible lots",
    "predecessors": ["DISP-012"],
    "edge_type": "data",
    "guard_condition": "lot.status in allowed & retest.valid",
    "decision_id": "Q-INV-03",
    "decision_outcome": "Released only",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Eligibility Log",
    "controls": "Block disallowed statuses"
  },
  {
    "id": "DISP-014",
    "parent_id": "DISP-M-002",
    "name": "ERP batch/lot determination (if configured)",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "SAP",
    "integration": "SAP",
    "inputs": "Eligible lots",
    "outputs": "ERP allocation",
    "predecessors": ["DISP-013"],
    "edge_type": "control",
    "guard_condition": "Q-ERP-01=SAP",
    "decision_id": "Q-ERP-01",
    "decision_outcome": "SAP",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "ERP Allocation Log",
    "controls": "ERP applies FIFO/FEFO"
  },
  {
    "id": "DISP-015",
    "parent_id": "DISP-M-002",
    "name": "MES allocation with policy per class",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Eligible lots",
    "outputs": "MES allocation",
    "predecessors": ["DISP-013"],
    "edge_type": "control",
    "guard_condition": "Q-ERP-01=MES",
    "decision_id": "Q-ERP-01",
    "decision_outcome": "MES",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "MES Allocation Log",
    "controls": "Expiry-aware selection"
  },
  {
    "id": "DISP-016",
    "parent_id": "DISP-M-002",
    "name": "Reserve lots; stage to dispensing area; verify mapping",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "Operator/WMS",
    "integration": "MES↔WMS",
    "inputs": "Picklist/TO",
    "outputs": "Staged containers",
    "predecessors": ["DISP-014", "DISP-015"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Staging Log",
    "controls": "Location scan required"
  },
  {
    "id": "DISP-017",
    "parent_id": "DISP-M-002",
    "name": "Identify container and verify against allocation",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "Operator",
    "integration": "MES/Scanner",
    "inputs": "Container barcode",
    "outputs": "Verified container",
    "predecessors": ["DISP-016"],
    "edge_type": "control",
    "guard_condition": "match(material, lot) AND expiry_at_dispense_valid",
    "decision_id": "C-VERIFY-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Container Verification Log",
    "controls": "Block on mismatch"
  },
  {
    "id": "DISP-018",
    "parent_id": "DISP-M-002",
    "name": "Cold-chain TOR timer start (if required)",
    "type": "Micro",
    "stage": "Material Allocation",
    "actor": "MES",
    "integration": "MES/Historian",
    "inputs": "Material attributes",
    "outputs": "TOR timer",
    "predecessors": ["DISP-016"],
    "edge_type": "timer",
    "guard_condition": "Q-ENV-02=Yes",
    "decision_id": "Q-ENV-02",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "TOR Log",
    "controls": "Alerts on exposure threshold"
  },
  {
    "id": "DISP-L-001",
    "parent_id": "DISP-M-003",
    "name": "Start container loop (weighing)",
    "type": "Loop-Start",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Target quantity",
    "outputs": "Running total=0",
    "predecessors": ["DISP-017"],
    "edge_type": "control",
    "guard_condition": "Q-SEC-01='Weighing only' OR Q-SEC-01='Both (material-dependent)'",
    "decision_id": "Q-SEC-01",
    "decision_outcome": "Weighing only,Both (material-dependent)",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Dispense Loop Log",
    "controls": "Iterate until target reached"
  },
  {
    "id": "DISP-020",
    "parent_id": "DISP-M-003",
    "name": "Select next container for weighing",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES/Scanner",
    "inputs": "Staged containers",
    "outputs": "Selected container",
    "predecessors": ["DISP-L-001"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Container Selection Log",
    "controls": "Damage/seal check mandatory"
  },
  {
    "id": "DISP-021",
    "parent_id": "DISP-M-003",
    "name": "Check container integrity (seal/label)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "Container",
    "outputs": "OK/Quarantine",
    "predecessors": ["DISP-020"],
    "edge_type": "exception",
    "guard_condition": "container.damaged=true",
    "decision_id": "C-DMG-01",
    "decision_outcome": "Yes → Quarantine",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "NCR Log",
    "controls": "Quarantine and replace"
  },
  {
    "id": "DISP-022",
    "parent_id": "DISP-M-003",
    "name": "Balance suitability vs target band",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "Balance↔MES",
    "inputs": "Target qty",
    "outputs": "Suitability decision",
    "predecessors": ["DISP-020"],
    "edge_type": "data",
    "guard_condition": "balance.suitable=true",
    "decision_id": "Q-WB-02",
    "decision_outcome": "Yes (enforce)",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Balance Usage Log",
    "controls": "Block unsuitable balance"
  },
  {
    "id": "DISP-023",
    "parent_id": "DISP-M-003",
    "name": "Select weighing method for this container",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "MES",
    "inputs": "Material policy",
    "outputs": "Method selection",
    "predecessors": ["DISP-022"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-WB-03",
    "decision_outcome": "Direct",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Method Selection Log",
    "controls": "Method-specific prompts"
  },
  {
    "id": "DISP-024",
    "parent_id": "DISP-M-003",
    "name": "Tare container / record empty weight",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "Balance/MES",
    "inputs": "Container",
    "outputs": "Tare value",
    "predecessors": ["DISP-023"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "WB Slip; Balance Usage Log",
    "controls": "Container whitelist enforced"
  },
  {
    "id": "DISP-025",
    "parent_id": "DISP-M-003",
    "name": "Pull assay & CoA; compute adjusted quantity",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "LIMS/ERP↔MES",
    "inputs": "CoA/Assay",
    "outputs": "Adjusted quantity",
    "predecessors": ["DISP-024"],
    "edge_type": "data",
    "guard_condition": "assay.available",
    "decision_id": "Q-LIMS-01",
    "decision_outcome": "LIMS via integration",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Potency Calc Log",
    "controls": "Audit calc; attach CoA"
  },
  {
    "id": "DISP-026",
    "parent_id": "DISP-M-003",
    "name": "Apply UoM conversion & rounding",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Adjusted qty",
    "outputs": "Rounded target",
    "predecessors": ["DISP-025"],
    "edge_type": "data",
    "guard_condition": "uom.table valid",
    "decision_id": "Q-UOM-01",
    "decision_outcome": "ERP master",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "UoM/Rounding Log",
    "controls": "Per Q-UOM-02 policy"
  },
  {
    "id": "DISP-026A",
    "parent_id": "DISP-M-003",
    "name": "Instrument handshake health check",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "Balance↔MES",
    "inputs": "Balance ID",
    "outputs": "Handshake OK",
    "predecessors": ["DISP-026"],
    "edge_type": "data",
    "guard_condition": "instrument.handshake=true",
    "decision_id": "C-WB-CONN-01",
    "decision_outcome": "Yes",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Instrument Comm Log",
    "controls": "If false, route to offline manual capture with photo + verifier"
  },
  {
    "id": "DISP-027",
    "parent_id": "DISP-M-003",
    "name": "Weigh material into dispense container",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "Balance/MES",
    "inputs": "Rounded target",
    "outputs": "Net weight",
    "predecessors": ["DISP-026"],
    "edge_type": "control",
    "guard_condition": "network.online=true",
    "decision_id": "C-NET-01",
    "decision_outcome": "Yes",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "WB Slip",
    "controls": "Tolerance ± per SOP"
  },
  {
    "id": "DISP-027S",
    "parent_id": "DISP-M-003",
    "name": "Spill detection gate",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "MES",
    "inputs": "Visual check",
    "outputs": "Spill status",
    "predecessors": ["DISP-027"],
    "edge_type": "exception",
    "guard_condition": "spill.occurred=true",
    "decision_id": "C-SPILL-01",
    "decision_outcome": "Yes → Spill workflow",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Spill Incident Log",
    "controls": "Block next step until cleanup completed"
  },
  {
    "id": "DISP-027C",
    "parent_id": "DISP-M-003",
    "name": "Spill cleanup per SOP and waste logging",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/QA",
    "integration": "MES↔QMS/WMS",
    "inputs": "SOP; spill details",
    "outputs": "Cleanup record; waste ticket",
    "predecessors": ["DISP-027S"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-DMG-01",
    "decision_outcome": "Continue by adding new container",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Spill Cleanup Log; Waste Log",
    "controls": "QA countersign if hazardous/HPAPI"
  },
  {
    "id": "DISP-027A",
    "parent_id": "DISP-M-003",
    "name": "Adjust inventory and re-weigh delta (if continuing)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES/Operator",
    "integration": "MES↔SAP",
    "inputs": "Spill quantity; target delta",
    "outputs": "Adjusted target; updated inventory",
    "predecessors": ["DISP-027C"],
    "edge_type": "control",
    "guard_condition": "policy.delta_add_allowed=true",
    "decision_id": "Q-DMG-01",
    "decision_outcome": "Continue by adding new container",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Delta Adjustment Log",
    "controls": "Re-run tolerance gate on new addition"
  },
  {
    "id": "DISP-028",
    "parent_id": "DISP-M-003",
    "name": "Network fallback capture (manual entry + photo)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "Display reading; photo",
    "outputs": "Manual record",
    "predecessors": ["DISP-026"],
    "edge_type": "exception",
    "guard_condition": "(network.online=false) OR (instrument.handshake=false)",
    "decision_id": "C-NET-01",
    "decision_outcome": "No → Offline capture",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Offline Capture Log",
    "controls": "Verifier e-sign on sync"
  },
  {
    "id": "DISP-029",
    "parent_id": "DISP-M-003",
    "name": "Check tolerance; deviation per policy if OOT",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES/QMS",
    "integration": "MES↔QMS",
    "inputs": "Net weight",
    "outputs": "Deviation (if any)",
    "predecessors": ["DISP-027", "DISP-028"],
    "edge_type": "exception",
    "guard_condition": "abs(error) > tolerance OR policy_requires_deviation",
    "decision_id": "C-TOL-01",
    "decision_outcome": "No → Handle per Q-WB-04",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Deviation Log",
    "controls": "CAPA link if required"
  },
  {
    "id": "DISP-030",
    "parent_id": "DISP-M-003",
    "name": "Print & affix container label; scan verify",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES/Printer",
    "inputs": "Net weight; lot; container ID",
    "outputs": "Container label",
    "predecessors": ["DISP-027"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Template version locked"
  },
  {
    "id": "DISP-030V",
    "parent_id": "DISP-M-003",
    "name": "Label scanback verification (uniqueness & match)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "MES/Scanner",
    "inputs": "Printed label",
    "outputs": "Verified label",
    "predecessors": ["DISP-030"],
    "edge_type": "control",
    "guard_condition": "scanback.match=true AND id.unique=true",
    "decision_id": "C-LBL-01",
    "decision_outcome": "Yes",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Label Verification Log",
    "controls": "If fail → auto-void and reprint per Q-LBL-03"
  },
  {
    "id": "DISP-030O",
    "parent_id": "DISP-M-003",
    "name": "Offline label issuance with manual template and QA countersign",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/QA",
    "integration": "Printer (offline)",
    "inputs": "Label data snapshot; pre-printed template",
    "outputs": "Manually issued label",
    "predecessors": ["DISP-030"],
    "edge_type": "exception",
    "guard_condition": "network.online=false",
    "decision_id": "C-NET-01",
    "decision_outcome": "No → Offline capture",
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Manual Label Log; Reconciliation Log",
    "controls": "Back-enter label ID when network restores"
  },
  {
    "id": "DISP-031",
    "parent_id": "DISP-M-003",
    "name": "Update running total; continue or finish",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Net weight",
    "outputs": "Running total",
    "predecessors": ["DISP-030"],
    "edge_type": "control",
    "guard_condition": "RunningTotal < Target",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Dispense Loop Log",
    "controls": "Loop until target"
  },
  {
    "id": "DISP-032",
    "parent_id": "DISP-M-003",
    "name": "Handle last-container partial use (remnant label)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator/MES",
    "integration": "MES/Printer",
    "inputs": "Remaining qty",
    "outputs": "Remnant label",
    "predecessors": ["DISP-031"],
    "edge_type": "exception",
    "guard_condition": "over_pour or partial_needed",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "",
    "logs": "Remnant Log",
    "controls": "Traceability for returned remnant"
  },
  {
    "id": "DISP-L-002",
    "parent_id": "DISP-M-003",
    "name": "End container loop (weighing)",
    "type": "Loop-End",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Running total",
    "outputs": "Loop closed",
    "predecessors": ["DISP-031"],
    "edge_type": "control",
    "guard_condition": "RunningTotal >= Target",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "ContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Dispense Loop Log",
    "controls": ""
  },
  {
    "id": "DISP-SL-001",
    "parent_id": "DISP-M-004",
    "name": "Start container loop (sealed, no weigh)",
    "type": "Loop-Start",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Target quantity",
    "outputs": "Running total=0",
    "predecessors": ["DISP-017"],
    "edge_type": "control",
    "guard_condition": "Q-SEC-01='Sealed only' OR Q-SEC-01='Both (material-dependent)'",
    "decision_id": "Q-SEC-01",
    "decision_outcome": "Sealed only,Both (material-dependent)",
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Sealed Loop Log",
    "controls": "Iterate until target reached"
  },
  {
    "id": "DISP-SL-002",
    "parent_id": "DISP-M-004",
    "name": "Scan sealed container; capture declared net mass from label",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES/Scanner",
    "inputs": "Warehouse label",
    "outputs": "Declared mass",
    "predecessors": ["DISP-SL-001"],
    "edge_type": "data",
    "guard_condition": "declared_mass present",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "",
    "logs": "Sealed Container Log",
    "controls": "No balance reading"
  },
  {
    "id": "DISP-SL-003",
    "parent_id": "DISP-M-004",
    "name": "Verify container integrity & eligibility (status/retest)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES/LIMS/ERP",
    "inputs": "Container attributes",
    "outputs": "Eligibility decision",
    "predecessors": ["DISP-SL-002"],
    "edge_type": "data",
    "guard_condition": "released=true & retest.valid",
    "decision_id": "C-REL-01",
    "decision_outcome": "Yes",
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "",
    "logs": "Eligibility Log",
    "controls": "Block if not released"
  },
  {
    "id": "DISP-SL-004",
    "parent_id": "DISP-M-004",
    "name": "Print & affix dispensed container label (sealed)",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "Operator",
    "integration": "MES/Printer",
    "inputs": "Declared mass; lot",
    "outputs": "Container label",
    "predecessors": ["DISP-SL-003"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Scan verification required"
  },
  {
    "id": "DISP-SL-005",
    "parent_id": "DISP-M-004",
    "name": "Update running total; continue or finish",
    "type": "Micro",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Declared mass",
    "outputs": "Running total",
    "predecessors": ["DISP-SL-004"],
    "edge_type": "control",
    "guard_condition": "RunningTotal < Target",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Sealed Loop Log",
    "controls": "Loop until target"
  },
  {
    "id": "DISP-SL-006",
    "parent_id": "DISP-M-004",
    "name": "End container loop (sealed)",
    "type": "Loop-End",
    "stage": "Weighing & Dispensing",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Running total",
    "outputs": "Loop closed",
    "predecessors": ["DISP-SL-005"],
    "edge_type": "control",
    "guard_condition": "RunningTotal >= Target",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "SealedContainerIndex",
    "loop_exit_condition": "RunningTotal >= Target",
    "logs": "Sealed Loop Log",
    "controls": ""
  },
  {
    "id": "DISP-040",
    "parent_id": "DISP-M-005",
    "name": "Label preview & content validation",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "MES",
    "integration": "MES",
    "inputs": "Container data",
    "outputs": "Validated content",
    "predecessors": ["DISP-L-002", "DISP-SL-006"],
    "edge_type": "data",
    "guard_condition": "content.valid=true",
    "decision_id": "Q-LBL-02",
    "decision_outcome": "GS1-128",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label QA Log",
    "controls": "Template version lock"
  },
  {
    "id": "DISP-041",
    "parent_id": "DISP-M-005",
    "name": "Enter additional manual label fields (if any)",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "Extra fields",
    "outputs": "Completed label data",
    "predecessors": ["DISP-040"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-LBL-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Data Log",
    "controls": "Field validation"
  },
  {
    "id": "DISP-042",
    "parent_id": "DISP-M-005",
    "name": "Print & affix aggregate/kit label (if required)",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "Operator",
    "integration": "MES/Printer",
    "inputs": "Container list; running total",
    "outputs": "Aggregate label",
    "predecessors": ["DISP-041"],
    "edge_type": "control",
    "guard_condition": "aggregate.required=true",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Scan verification required"
  },
  {
    "id": "DISP-042V",
    "parent_id": "DISP-M-005",
    "name": "Aggregate/kit label scanback verification",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "Operator/MES",
    "integration": "MES/Scanner",
    "inputs": "Aggregate label",
    "outputs": "Verified aggregate label",
    "predecessors": ["DISP-042"],
    "edge_type": "control",
    "guard_condition": "scanback.match=true AND id.unique=true",
    "decision_id": "C-LBL-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Verification Log",
    "controls": "If fail → reprint/void per policy"
  },
  {
    "id": "DISP-043",
    "parent_id": "DISP-M-005",
    "name": "Reprint/void handling per policy",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "Operator/QA",
    "integration": "MES",
    "inputs": "Reprint request",
    "outputs": "New label; voided label",
    "predecessors": ["DISP-042"],
    "edge_type": "exception",
    "guard_condition": "reprint=true",
    "decision_id": "Q-LBL-03",
    "decision_outcome": "QA approval required",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Auto-void previous; audit"
  },
  {
    "id": "DISP-044",
    "parent_id": "DISP-M-005",
    "name": "Label reconciliation (printed vs used vs voided)",
    "type": "Micro",
    "stage": "Labeling & Documentation",
    "actor": "Operator",
    "integration": "MES",
    "inputs": "Label events",
    "outputs": "Recon report",
    "predecessors": ["DISP-042"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Label Reconciliation Log",
    "controls": "Exceptions flagged"
  },
  {
    "id": "DISP-050",
    "parent_id": "DISP-M-006",
    "name": "Assign storage/transfer location & initiate move",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "Operator/Warehouse",
    "integration": "MES↔WMS",
    "inputs": "Container IDs",
    "outputs": "TO/Move",
    "predecessors": ["DISP-044"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-WMS-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Chain-of-Custody Log",
    "controls": "TO number captured"
  },
  {
    "id": "DISP-051",
    "parent_id": "DISP-M-006",
    "name": "Handover scan at receiving area (chain-of-custody)",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "Operator",
    "integration": "MES/Scanner",
    "inputs": "Container IDs",
    "outputs": "Handover record",
    "predecessors": ["DISP-050"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Chain-of-Custody Log",
    "controls": "Both parties e-sign"
  },
  {
    "id": "DISP-052",
    "parent_id": "DISP-M-006",
    "name": "Post goods issue/consumption to ERP (per policy)",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "MES/ERP",
    "integration": "MES↔SAP",
    "inputs": "Dispense data",
    "outputs": "ERP GI",
    "predecessors": ["DISP-051"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": "Q-CONS-01",
    "decision_outcome": "At dispensing",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "ERP Posting Log",
    "controls": "Posting proof stored"
  },
  {
    "id": "DISP-052A",
    "parent_id": "DISP-M-006",
    "name": "ERP GI posting acknowledgement check and retry queue",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "MES/ERP",
    "integration": "MES↔SAP",
    "inputs": "Posting ID",
    "outputs": "Acknowledged or queued retry",
    "predecessors": ["DISP-052"],
    "edge_type": "data",
    "guard_condition": "ack.received=true",
    "decision_id": "C-GI-ACK-01",
    "decision_outcome": "Yes",
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "ERP Posting Log; Retry Queue",
    "controls": "Escalate to QA/SAP support on repeated failures"
  },
  {
    "id": "DISP-053",
    "parent_id": "DISP-M-006",
    "name": "Variance reconciliation against BOM and policy",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "MES/QA",
    "integration": "MES",
    "inputs": "Dispensed vs required",
    "outputs": "Variance report",
    "predecessors": ["DISP-052"],
    "edge_type": "data",
    "guard_condition": "variance computed",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Variance Log",
    "controls": "Threshold alerts"
  },
  {
    "id": "DISP-054",
    "parent_id": "DISP-M-006",
    "name": "Close deviations/exceptions & attach evidence",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "QA",
    "integration": "MES↔QMS/DMS",
    "inputs": "Open deviations",
    "outputs": "Closed records",
    "predecessors": ["DISP-053"],
    "edge_type": "control",
    "guard_condition": "open_deviations=0",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Deviation Log",
    "controls": "Final QA e-sign"
  },
  {
    "id": "DISP-055",
    "parent_id": "DISP-M-006",
    "name": "Archive logs (CoA, WB slips, TOR) & finalize record",
    "type": "Micro",
    "stage": "Post-Dispensing",
    "actor": "MES",
    "integration": "MES/DMS",
    "inputs": "All logs",
    "outputs": "Archived batch record",
    "predecessors": ["DISP-054"],
    "edge_type": "control",
    "guard_condition": "",
    "decision_id": null,
    "decision_outcome": null,
    "loop_key": "",
    "loop_exit_condition": "",
    "logs": "Archive Log",
    "controls": "Immutable record stored"
  }
]