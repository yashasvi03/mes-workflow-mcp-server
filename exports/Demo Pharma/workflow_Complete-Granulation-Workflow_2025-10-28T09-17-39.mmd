%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e1f5ff','primaryTextColor':'#01579b','primaryBorderColor':'#0288d1','lineColor':'#546e7a','secondaryColor':'#fff9e1','tertiaryColor':'#f3e5f5'}}}%%
graph TB
  classDef macroStyle fill:#0288d1,stroke:#01579b,stroke-width:4px,color:#ffffff,font-weight:bold,font-size:16px
  classDef microStyle fill:#fff9e1,stroke:#f9a825,stroke-width:2px,color:#3e2723,font-size:14px
  classDef loopStyle fill:#8e24aa,stroke:#4a148c,stroke-width:3px,color:#ffffff,font-weight:bold,font-size:14px
  classDef exceptionStyle fill:#ffcdd2,stroke:#c62828,stroke-width:3px,stroke-dasharray:8 4,color:#b71c1c,font-weight:bold
  classDef decisionStyle fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#e65100,font-weight:bold
  classDef convergeStyle fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#1b5e20,font-weight:bold

  START([ğŸ START GRANULATION])
  style START fill:#4caf50,stroke:#2e7d32,stroke-width:4px,color:#ffffff,font-weight:bold,font-size:18px

  M1["ğŸ”¬ PRE-GRANULATION<br/>EQUIPMENT READINESS"]
  class M1 macroStyle
  START --> M1

  T101["ğŸ“‹ Retrieve Batch Order<br/>& Master Recipe"]
  T102["ğŸ§¹ Request Line<br/>Clearance"]
  class T101,T102 microStyle
  M1 --> T101
  T101 --> T102

  D103{"âœ“ Cleaning<br/>Valid?"}
  T103A["âœ… Cleaning<br/>Verification OK"]
  T103B["âš ï¸ RE-CLEAN<br/>Equipment"]
  class D103 decisionStyle
  class T103A microStyle
  class T103B exceptionStyle
  T102 --> D103
  D103 -->|YES| T103A
  D103 -.->|NO| T103B
  T103B -.-> T103A

  D104{"âš–ï¸ Instruments<br/>Calibrated?"}
  T104A["âœ… Calibration<br/>Valid"]
  T104B["âš ï¸ CALIBRATE<br/>or Block"]
  class D104 decisionStyle
  class T104A microStyle
  class T104B exceptionStyle
  T103A --> D104
  D104 -->|YES| T104A
  D104 -.->|NO| T104B
  T104B -.-> T104A

  T105["ğŸŒ¡ï¸ Monitor Environment<br/>T/RH - Automated"]
  class T105 microStyle
  T104A --> T105

  D106{"ğŸŒ¡ï¸ Environment<br/>Within Range?"}
  T106A["âœ… Environment<br/>Acceptable"]
  T106B["âš ï¸ PAUSE<br/>Deviation"]
  class D106 decisionStyle
  class T106A microStyle
  class T106B exceptionStyle
  T105 --> D106
  D106 -->|YES| T106A
  D106 -.->|NO| T106B
  T106B -.-> T106A

  T107["âœ… Equipment<br/>Ready Sign-Off"]
  class T107 convergeStyle
  T106A --> T107

  M2["ğŸ“¦ MATERIAL TRANSFER<br/>& VERIFICATION"]
  class M2 macroStyle
  T107 ==> M2

  T201["ğŸ“¥ Receive Dispensed<br/>Materials"]
  T202["ğŸ“± Barcode Scan<br/>Mandatory Verification"]
  T203["ğŸ” Container Integrity<br/>Visual + Seal Check"]
  T204["âœ… Material<br/>Verification Complete"]
  class T201,T202,T203,T204 microStyle
  M2 --> T201
  T201 --> T202
  T202 --> T203
  T203 --> T204

  M3["ğŸ’§ BINDER SOLUTION<br/>PREPARATION"]
  class M3 macroStyle
  T204 ==> M3

  T301["âš—ï¸ Pre-Made Batch<br/>in Separate Vessel"]
  T302["ğŸ§ª QC Testing<br/>Concentration + pH"]
  T303["âœ… Binder Solution<br/>Approved"]
  class T301,T302,T303 microStyle
  M3 --> T301
  T301 --> T302
  T302 --> T303

  M4["ğŸ”„ GRANULATION<br/>PROCESS"]
  class M4 macroStyle
  T303 ==> M4

  T401["ğŸ“‹ Load MES Master<br/>Recipe & Setpoints"]
  T402["ğŸ›ï¸ Configure SCADA<br/>Automated Setpoints"]
  class T401,T402 microStyle
  M4 --> T401
  T401 --> T402

  D403{"âš™ï¸ Wet Granulation<br/>Setpoints OK?"}
  T403A["âœ… Setpoints<br/>Within Range"]
  T403B["âš ï¸ ADJUST<br/>or Block"]
  class D403 decisionStyle
  class T403A microStyle
  class T403B exceptionStyle
  T402 --> D403
  D403 -->|YES| T403A
  D403 -.->|NO| T403B
  T403B -.-> T403A

  T404["ğŸ’§ Continuous Spray<br/>Binder Addition"]
  T405["ğŸ”„ Automated Data<br/>Capture - SCADA"]
  T406["ğŸ“Š Monitor Process<br/>Parameters"]
  class T404,T405,T406 microStyle
  T403A --> T404
  T404 --> T405
  T405 --> T406

  D407{"ğŸ¯ Endpoint<br/>Reached?"}
  class D407 decisionStyle
  T406 --> D407
  D407 -.->|NO - Continue| T406
  D407 -->|YES| T408

  T408["ğŸ›‘ Stop Granulation<br/>Process"]
  class T408 microStyle

  D409{"ğŸ”§ Equipment<br/>Failure?"}
  T409A["âœ… Process<br/>Complete"]
  T409B["âš ï¸ TERMINATE<br/>Batch"]
  class D409 decisionStyle
  class T409A microStyle
  class T409B exceptionStyle
  T408 --> D409
  D409 -->|NO| T409A
  D409 -.->|YES - Cannot Recover| T409B

  T410["ğŸ§ª IPC Testing<br/>Moisture/PSD/Bulk Density"]
  T411["ğŸ“¤ Auto-Import from LIMS"]
  class T410,T411 microStyle
  T409A --> T410
  T410 --> T411

  D412{"ğŸ“Š IPC Results<br/>Within Spec?"}
  T412A["âœ… IPC<br/>Acceptable"]
  T412B["âš ï¸ DEVIATION<br/>Workflow - MES Integrated"]
  class D412 decisionStyle
  class T412A microStyle
  class T412B exceptionStyle
  T411 --> D412
  D412 -->|YES| T412A
  D412 -.->|NO| T412B
  T412B -.-> T412A

  T413["ğŸ§® Auto-Calculate<br/>Binder % & Yield"]
  class T413 microStyle
  T412A --> T413

  M5["ğŸ“¤ POST-GRANULATION<br/>HANDLING"]
  class M5 macroStyle
  T413 ==> M5

  T501["ğŸ·ï¸ Print GS1-128<br/>Barcode + Manual Fields"]
  T502["âœ… Label<br/>Verification"]
  T503["ğŸ§ª Collect Retain Sample<br/>with Chain-of-Custody"]
  T504["ğŸ“ Transfer to<br/>Intermediate Hold Area"]
  class T501,T502,T503,T504 microStyle
  M5 --> T501
  T501 --> T502
  T502 --> T503
  T503 --> T504

  D505{"ğŸ‘¨â€ğŸ”¬ QA Release<br/>Decision?"}
  T505A["âœ… Released"]
  T505B["â›” Hold"]
  T505C["ğŸ”„ Conditional<br/>Rework"]
  class D505 decisionStyle
  class T505A convergeStyle
  class T505B exceptionStyle
  class T505C exceptionStyle
  T504 --> D505
  D505 -->|APPROVED| T505A
  D505 -.->|REJECTED| T505B
  D505 -.->|CONDITIONAL| T505C

  T506["ğŸ“Š Yield Variance<br/>Check Â±5%"]
  class T506 microStyle
  T505A --> T506

  D507{"ğŸ“‰ Variance<br/>Within Threshold?"}
  T507A["âœ… Yield<br/>Acceptable"]
  T507B["âš ï¸ INVESTIGATION<br/>Triggered"]
  class D507 decisionStyle
  class T507A microStyle
  class T507B exceptionStyle
  T506 --> D507
  D507 -->|YES - Within Â±5%| T507A
  D507 -.->|NO - Exceeds Â±5%| T507B
  T507B -.-> T507A

  T508["ğŸ§¹ Initiate Cleaning<br/>After Each Batch"]
  class T508 microStyle
  T507A --> T508

  M6["ğŸ“‹ BATCH RECORD<br/>CLOSEOUT"]
  class M6 macroStyle
  T508 ==> M6

  T601["ğŸ“ Generate Full<br/>Electronic eBMR"]
  T602["âœï¸ 21 CFR Part 11<br/>Electronic Signatures"]
  T603["ğŸ“Š ERP Posting<br/>On QA Approval"]
  class T601,T602,T603 microStyle
  M6 --> T601
  T601 --> T602
  T602 --> T603

  D604{"ğŸ‘¨â€ğŸ”¬ QA Batch<br/>Review?"}
  T604A["âœ… Batch<br/>Approved"]
  T604B["â›” Batch<br/>Rejected"]
  T604C["â¸ï¸ Pending<br/>Investigation"]
  class D604 decisionStyle
  class T604A convergeStyle
  class T604B exceptionStyle
  class T604C exceptionStyle
  T603 --> D604
  D604 -->|APPROVED| T604A
  D604 -.->|REJECTED| T604B
  D604 -.->|CONDITIONAL| T604C

  T605["ğŸ“ Electronic Archive<br/>Validated System"]
  T606["âœ… Records Retention<br/>per Policy"]
  class T605,T606 microStyle
  T604A --> T605
  T605 --> T606

  COMPLETE([ğŸ‰ GRANULATION COMPLETE])
  style COMPLETE fill:#4caf50,stroke:#2e7d32,stroke-width:4px,color:#ffffff,font-weight:bold,font-size:18px
  T606 ==> COMPLETE
